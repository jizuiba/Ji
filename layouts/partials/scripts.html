<!-- Main JavaScript -->
{{ $js := resources.Get "js/main.js" | resources.Minify | resources.Fingerprint }}
<script src="{{ $js.RelPermalink }}" integrity="{{ $js.Data.Integrity }}"></script>

<!-- Dynamic Header JavaScript -->
{{ $dynamicHeaderJS := resources.Get "js/dynamic-header.js" | resources.Minify | resources.Fingerprint }}
<script src="{{ $dynamicHeaderJS.RelPermalink }}" integrity="{{ $dynamicHeaderJS.Data.Integrity }}"></script>

<!-- Search functionality -->
{{ if .Site.Params.search }}
  {{ $searchJS := resources.Get "js/search.js" | resources.Minify | resources.Fingerprint }}
  <script src="{{ $searchJS.RelPermalink }}" integrity="{{ $searchJS.Data.Integrity }}"></script>
{{ end }}

<!-- Code highlighting -->
{{ if .Site.Params.syntaxHighlighting }}
  <script>
    window.themeConfig = {
      showLineNumbers: {{ .Site.Params.showLineNumbers | default true }}
    };
  </script>
  {{ $codeJS := resources.Get "js/code-highlight.js" | resources.Minify | resources.Fingerprint }}
  <script src="{{ $codeJS.RelPermalink }}" integrity="{{ $codeJS.Data.Integrity }}"></script>
{{ end }}

<!-- Table of Contents -->
{{ if .TableOfContents }}
  {{ $tocJS := resources.Get "js/toc.js" | resources.Minify | resources.Fingerprint }}
  <script src="{{ $tocJS.RelPermalink }}" integrity="{{ $tocJS.Data.Integrity }}"></script>
{{ end }}

<!-- Featured Image Optimization -->
{{ if .Params.featured_image }}
  {{ $featuredImageJS := resources.Get "js/featured-image.js" | resources.Minify | resources.Fingerprint }}
  <script src="{{ $featuredImageJS.RelPermalink }}" integrity="{{ $featuredImageJS.Data.Integrity }}"></script>
{{ end }}

<!-- Custom JavaScript -->
{{ if .Site.Params.customJS }}
  {{ range .Site.Params.customJS }}
    <script src="{{ . | relURL }}"></script>
  {{ end }}
{{ end }}

<!-- Page-specific JavaScript -->
{{ if .Params.customJS }}
  {{ range .Params.customJS }}
    <script src="{{ . | relURL }}"></script>
  {{ end }}
{{ end }}

<!-- Mermaid Diagrams (loaded only when needed) -->
{{ if .Store.Get "hasMermaid" }}
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';

    const lightConfig = {
      theme: 'default',
      themeVariables: {
        background: 'transparent',
        primaryColor: '#0a3069',
        primaryTextColor: '#24292f',
        primaryBorderColor: '#0a3069',
        lineColor: '#0a3069',
        textColor: '#24292f',
        tertiaryColor: '#f6f8fa'
      }
    };

    const darkConfig = {
      theme: 'dark',
      themeVariables: {
        background: 'transparent',
        primaryColor: '#58a6ff',
        primaryTextColor: '#e6edf3',
        primaryBorderColor: '#58a6ff',
        lineColor: '#58a6ff',
        textColor: '#e6edf3',
        tertiaryColor: '#161b22'
      }
    };

    function isDarkTheme() {
      return document.documentElement.classList.contains('theme-dark');
    }

    function initializeMermaidForCurrentTheme(startOnLoad = true) {
      const config = isDarkTheme() ? darkConfig : lightConfig;
      mermaid.initialize({ startOnLoad, ...config });
    }

    function renderMermaid(selector = '.mermaid, pre.mermaid, .language-mermaid') {
      mermaid.run({ querySelector: selector });
    }

    // Initial init + render
    initializeMermaidForCurrentTheme(true);

    // Re-render on theme changes
    const themeObserver = new MutationObserver(() => {
      initializeMermaidForCurrentTheme(false);
      renderMermaid();
    });
    themeObserver.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
  </script>
{{ end }}

<!-- Analytics -->
{{ if .Site.Params.analytics }}
  {{ if .Site.Params.analytics.google }}
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ .Site.Params.analytics.google }}"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', '{{ .Site.Params.analytics.google }}');
    </script>
  {{ end }}
  
  {{ if .Site.Params.analytics.plausible }}
    <!-- Plausible Analytics -->
    <script defer data-domain="{{ .Site.Params.analytics.plausible }}" src="https://plausible.io/js/script.js"></script>
  {{ end }}
{{ end }}

<!-- Comments -->
{{ if .Site.Params.comments }}
  {{ if .Site.Params.comments.disqus }}
    <!-- Disqus -->
    <script>
      (function() {
        var d = document, s = d.createElement('script');
        s.src = 'https://{{ .Site.Params.comments.disqus }}.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();
    </script>
  {{ end }}
  
  {{ if .Site.Params.comments.utterances }}
    <!-- Utterances -->
    <script src="https://utteranc.es/client.js"
            repo="{{ .Site.Params.comments.utterances.repo }}"
            issue-term="{{ .Site.Params.comments.utterances.issueTerm | default "pathname" }}"
            theme="{{ .Site.Params.comments.utterances.theme | default "github-light" }}"
            crossorigin="anonymous"
            async>
    </script>
  {{ end }}
{{ end }}
