<!-- Preload Critical Resources -->
{{ if .Site.Params.preloadFonts }}
  {{ range .Site.Params.preloadFonts }}
    <link rel="preload" href="{{ .url }}" as="font" type="font/woff2" crossorigin>
  {{ end }}
{{ end }}

<!-- Critical JavaScript -->
<script>
  // Theme detection and initialization
  (function() {
    'use strict';
    
    // Remove no-js class
    document.documentElement.classList.remove('no-js');
    
    // Theme detection
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    if (savedTheme) {
      document.documentElement.classList.add('theme-' + savedTheme);
    } else if (prefersDark) {
      document.documentElement.classList.add('theme-dark');
    }
    
    // Initialize theme icon after theme is set
    setTimeout(updateThemeIcon, 0);
    
    // Theme toggle functionality
    window.toggleTheme = function() {
      const isDark = document.documentElement.classList.contains('theme-dark');
      const newTheme = isDark ? 'light' : 'dark';
      
      document.documentElement.classList.remove('theme-light', 'theme-dark');
      document.documentElement.classList.add('theme-' + newTheme);
      localStorage.setItem('theme', newTheme);
      
      // Update theme icon immediately
      updateThemeIcon();
    };
    
    // Theme icon update function
    function updateThemeIcon() {
      const isDark = document.documentElement.classList.contains('theme-dark');
      const themeToggle = document.querySelector('.theme-toggle');
      
      if (themeToggle) {
        const lightIcon = themeToggle.querySelector('.theme-icon-light');
        const darkIcon = themeToggle.querySelector('.theme-icon-dark');
        
        if (lightIcon && darkIcon) {
          // Force update with !important to override any conflicting styles
          if (isDark) {
            lightIcon.style.setProperty('opacity', '0', 'important');
            darkIcon.style.setProperty('opacity', '1', 'important');
          } else {
            lightIcon.style.setProperty('opacity', '1', 'important');
            darkIcon.style.setProperty('opacity', '0', 'important');
          }
        }
      }
    }
    
    // Smooth scrolling for anchor links
    document.addEventListener('click', function(e) {
      if (e.target.matches('a[href^="#"]')) {
        e.preventDefault();
        const target = document.querySelector(e.target.getAttribute('href'));
        if (target) {
          target.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
      }
    });
    
    // Skip link functionality
    const skipLink = document.querySelector('.skip-link');
    if (skipLink) {
      skipLink.addEventListener('click', function(e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
          target.focus();
          target.scrollIntoView();
        }
      });
    }
  })();
</script>

<!-- Service Worker Registration -->
{{ if .Site.Params.serviceWorker }}
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('/sw.js')
        .then(function(registration) {
          console.log('ServiceWorker registration successful');
        })
        .catch(function(err) {
          console.log('ServiceWorker registration failed');
        });
    });
  }
</script>
{{ end }}
